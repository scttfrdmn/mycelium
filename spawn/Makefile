.PHONY: all build build-spawn build-spored build-all clean install test test-coverage test-short

# Version
VERSION ?= 0.1.0

# Build directory
BUILD_DIR = bin

all: build

# Build for current platform
build: build-spawn build-spored

build-spawn:
	@echo "Building spawn..."
	@mkdir -p $(BUILD_DIR)
	go build -o $(BUILD_DIR)/spawn main.go

build-spored:
	@echo "Building spored..."
	@mkdir -p $(BUILD_DIR)
	go build -o $(BUILD_DIR)/spored cmd/spored/main.go

# Build for all platforms
build-all: build-linux-amd64 build-linux-arm64 build-darwin-amd64 build-darwin-arm64 build-windows-amd64

# Linux AMD64 (x86_64)
build-linux-amd64:
	@echo "Building for Linux AMD64..."
	@mkdir -p $(BUILD_DIR)
	GOOS=linux GOARCH=amd64 go build -o $(BUILD_DIR)/spawn-linux-amd64 main.go
	GOOS=linux GOARCH=amd64 go build -o $(BUILD_DIR)/spored-linux-amd64 cmd/spored/main.go

# Linux ARM64 (Graviton)
build-linux-arm64:
	@echo "Building for Linux ARM64 (Graviton)..."
	@mkdir -p $(BUILD_DIR)
	GOOS=linux GOARCH=arm64 go build -o $(BUILD_DIR)/spawn-linux-arm64 main.go
	GOOS=linux GOARCH=arm64 go build -o $(BUILD_DIR)/spored-linux-arm64 cmd/spored/main.go

# macOS AMD64 (Intel)
build-darwin-amd64:
	@echo "Building for macOS AMD64..."
	@mkdir -p $(BUILD_DIR)
	GOOS=darwin GOARCH=amd64 go build -o $(BUILD_DIR)/spawn-darwin-amd64 main.go
	GOOS=darwin GOARCH=amd64 go build -o $(BUILD_DIR)/spored-darwin-amd64 cmd/spored/main.go

# macOS ARM64 (M1/M2)
build-darwin-arm64:
	@echo "Building for macOS ARM64..."
	@mkdir -p $(BUILD_DIR)
	GOOS=darwin GOARCH=arm64 go build -o $(BUILD_DIR)/spawn-darwin-arm64 main.go
	GOOS=darwin GOARCH=arm64 go build -o $(BUILD_DIR)/spored-darwin-arm64 cmd/spored/main.go

# Windows AMD64
build-windows-amd64:
	@echo "Building for Windows AMD64..."
	@mkdir -p $(BUILD_DIR)
	GOOS=windows GOARCH=amd64 go build -o $(BUILD_DIR)/spawn-windows-amd64.exe main.go
	# Note: spored is Linux-only (runs on instances)

# Install locally
install: build
	@echo "Installing spawn and spored..."
	@cp $(BUILD_DIR)/spawn /usr/local/bin/
	@cp $(BUILD_DIR)/spored /usr/local/bin/
	@echo "Installed to /usr/local/bin/"

# Clean build artifacts
clean:
	@echo "Cleaning..."
	@rm -rf $(BUILD_DIR)

# Run tests
test:
	@echo "Running tests..."
	go test -v ./...

# Run tests with coverage
test-coverage:
	@echo "Running tests with coverage..."
	go test -v -coverprofile=coverage.out ./...
	@echo ""
	@echo "Coverage Summary:"
	@go tool cover -func=coverage.out | tail -1
	@echo ""
	@echo "Generating HTML coverage report..."
	@go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report saved to: coverage.html"
	@echo ""
	@echo "To view report: open coverage.html"

# Run short tests only
test-short:
	@echo "Running short tests..."
	go test -v -short ./...

# Development
dev: build
	@echo "Built for development"

# Create release archives
release: build-all
	@echo "Creating release archives..."
	@mkdir -p release
	tar czf release/spawn-$(VERSION)-linux-amd64.tar.gz -C $(BUILD_DIR) spawn-linux-amd64 spored-linux-amd64
	tar czf release/spawn-$(VERSION)-linux-arm64.tar.gz -C $(BUILD_DIR) spawn-linux-arm64 spored-linux-arm64
	tar czf release/spawn-$(VERSION)-darwin-amd64.tar.gz -C $(BUILD_DIR) spawn-darwin-amd64 spored-darwin-amd64
	tar czf release/spawn-$(VERSION)-darwin-arm64.tar.gz -C $(BUILD_DIR) spawn-darwin-arm64 spored-darwin-arm64
	@echo "Release archives created in release/"

.DEFAULT_GOAL := build
